version: 2
defaults: &defaults
  docker:
    - image: ubuntu:19.04
jobs:
  build_linux:
    <<: *defaults
    environment:
      MAPTOOL_CMD: "bin/navit/maptool/maptool -P  -6 -k"
    steps:
      - checkout
      - run:
          name: Id
          command: cat /etc/*release
      - run:
          name: Setup requirements
          command: |
            apt-get update
            apt-get install -y libpng-dev libfreetype6-dev libdbus-glib-1-dev libgtk2.0-dev curl
            apt-get install -y libtool-bin libssl-dev autoconf wget
      - run:
          name: Build for Linux
          command: |
            export CFLAGS=" -finline-limit=1 -fkeep-inline-functions -O0 -DNO_GTYPES_ -DPLUGSSS -g -DONLY_C_BORDER -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -ldl -lpthread "
            export CFLAGS=" -DNAVIT_TRANS_LAT_LON_GEO_NOFUNCS -DMAPTOOL ""$CFLAGS" ;
            ./autogen.sh
            ls -la ../
            mkdir bin
            cd bin
            ../configure --disable-samplemap --disable-graphics-opengl --disable-svg --disable-svg2png --disable-binding-python --disable-fastmath --disable-gui-gtk --disable-gui-win32 --disable-gui-qml
            cd navit
            make
            make version.h
            cd maptool
            make
            ldd maptool
            ls -la
      
      - run:
          name: Get OSM data
          command: wget -c -O map1.osm.bz2 http://download.geofabrik.de/europe/luxembourg-latest.osm.bz2
          no_output_timeout: 120m
      - run:
          name: Convert map
          command: bzcat ~/map1.osm.bz2 | ./maptool -o runtimes.sqlite -6 -k -n -U testmap.bin
          no_output_timeout: 120m
#      - run:
#          name: Get OSM data for Belgium
#          command: wget -c -O belgium-latest.osm.pbf http://download.geofabrik.de/europe/belgium-latest.osm.pbf
#          no_output_timeout: 120m
#      - run:
#          name: Get OSM data for Luxembourg
#          command: wget -c -O luxembourg-latest.osm.pbf http://download.geofabrik.de/europe/luxembourg-latest.osm.pbf
#          no_output_timeout: 120m
#      - run:
#          name: Setup Osmium
#          command: apt-get install -y osmium-tool
#      - run:
#          name: Combine PBF's
#          command: osmium merge -v belgium-latest.osm.pbf luxembourg-latest.osm.pbf france-latest.osm.pbf -o europe-latest.osm.pbf
      - run:
          name: split binfile
          command: |
            ls -la
            mkdir out
            cd out
            split -b 2G ../map.bin MAP
            ls -la
            cd ..
            ls -la
            
# join them with cmd /c copy /b BFRLaa+BFRLab BFRLtoday.bin
      - store_artifacts:
          path: out
workflows:
  version: 2
  build_all:
    jobs:
      - build_linux
      
